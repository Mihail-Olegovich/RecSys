# Сервис рекомендаций reco_service

## Описание проекта

`reco_service` — это сервис рекомендаций, реализованный на основе FastAPI, использующий модель k-NN для поиска похожих пользователей и предоставления рекомендаций на основе их истории просмотров. Сервис включает в себя обработку исключений, ведение логов и механизм авторизации с помощью API ключа.

## Ключевые компоненты

Сервис состоит из следующих основных компонентов:

* **API:**  Реализован с использованием FastAPI, предоставляет RESTful API для получения рекомендаций.  Основные функции реализованы в `service/api/views.py`.
* **Модель рекомендаций:**  Использует модель k-NN, реализованную в `service/api/userknn.py`, для генерации рекомендаций.  Загрузка и инициализация модели происходит в `service/api/app.py`.
* **Обработка ошибок:**  В `service/api/exception_handlers.py` реализована обработка различных типов исключений, обеспечивающая возвращение клиенту понятных сообщений об ошибках.
* **Логирование:**  Модуль `service/log.py` отвечает за логирование событий приложения и запросов.
* **Настройки:**  Конфигурация сервиса, включая параметры логирования и авторизации, хранится в `service/settings.py` и загружается из переменных окружения.


## Основные модули

* `service/`: Содержит основной код сервиса, разделенный на подмодули:
    * `service/api/`:  API-контроллеры и обработчики запросов.
    * `service/settings.py`:  Настройки сервиса.
    * `service/log.py`:  Настройки и функции логирования.
    * `service/models.py`:  Pydantic модели для данных.
* `tests/`:  Содержит модульные тесты для проверки корректности работы сервиса.


## Технологический стек

* Python (>=3.9,<3.13)
* FastAPI
* Pydantic
* Uvicorn/Gunicorn
* uvloop
* orjson
* Starlette
* httpx
* pydantic-settings
* pandas
* hnswlib
* implicit
* rectools
* joblib
* pytest (для тестирования)


## Структура проекта

```
reco_service/
├── service/
│   ├── api/
│   │   ├── app.py
│   │   ├── exception_handlers.py
│   │   ├── exceptions.py
│   │   ├── get_ann_reco.py
│   │   ├── middlewares.py
│   │   ├── userknn.py
│   │   └── views.py
│   ├── log.py
│   ├── models.py
│   ├── response.py
│   └── settings.py
├── tests/
│   └── api/
│       └── test_views.py
├── gunicorn.config.py
├── main.py
├── pyproject.toml
└── README.md
```


## Установка

1.  Клонируйте репозиторий: `git clone <репозиторий>`
2.  Перейдите в директорию проекта: `cd reco_service`
3.  Создайте и активируйте виртуальное окружение: `make setup`
4.  Установите зависимости:  (Зависимости уже установлены командой `make setup`)


## Запуск / Использование

1.  Запустите сервис с помощью Uvicorn: `uvicorn main:app --host 0.0.0.0 --port 8080` (или задайте другие значения HOST и PORT через переменные окружения).
2.  Запустите сервис с помощью Gunicorn (рекомендуется для продакшена): `gunicorn main:app -c gunicorn.config.py`
3.  Отправьте GET запрос на `/reco/{model_name}/{user_id}` с заголовком `Authorization: Bearer <ваш_api_key>`, где `{model_name}` - название модели (например, "UserKnn"), а `{user_id}` - ID пользователя.  Пример: `curl -H "Authorization: Bearer <ваш_api_key>" "http://localhost:8080/reco/UserKnn/123"`


## Развертывание

Для развертывания в продакшене используется Gunicorn, настроенный в `gunicorn.config.py`.  Настройки Gunicorn могут быть изменены через переменные окружения.


## Тестирование

Запуск тестов: `make test`


